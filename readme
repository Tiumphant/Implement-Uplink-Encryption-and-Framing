What This Task Actually Does (Simple Explanation)
You built a LoRaWAN-style secure message builder in C++.
When a device sends data in LoRaWAN:
Sensor Data â†’ Encrypt â†’ Add Frame Counter â†’ Sign â†’ Build Packet â†’ Send


Your project implements:
ğŸ” Encryption
Uses AppSKey
Encrypts application payload
Prevents data reading
âœï¸ Signing (MIC)

Uses NwkSKey
Creates message integrity code
Prevents tampering
ğŸ”¢ Frame Counter (fCntUp)
Increases every message
Prevents replay attack

ğŸ“¦ Payload Builder
Builds final LoRaWAN uplink packet format   
ğŸ§ª Google Test

Verifies encryption & payload logic

âœ… How It Works â€” Flow
User Data
   â†“
encryptPayload(AppSKey)
   â†“
Build Header + DevAddr + FCnt
   â†“
Create MIC using NwkSKey
   â†“
Final LoRaWAN Packet

âœ… Simple Architecture (Human Language)

Think of it like a factory:

           +------------------+
           |   Application    |
           |   Payload Data   |
           +--------+---------+
                    |
                    v
           +------------------+
           | Crypto Engine    |
           | AES + CMAC       |
           +--------+---------+
                    |
                    v
           +------------------+
           | Frame Counter    |
           | Manager          |
           +--------+---------+
                    |
                    v
           +------------------+
           | Payload Builder  |
           | LoRa Packet      |
           +--------+---------+
                    |
                    v
              Final Packet

âœ… Common Errors That Can Come + Fix
âŒ Error 1 â€” OpenSSL Not Found
fatal error: openssl/evp.h: No such file

âœ… Fix
sudo apt install libssl-dev

âŒ Error 2 â€” OpenSSL Deprecated Warnings
AES_encrypt deprecated
CMAC deprecated

âœ… Fix

Use EVP-based Crypto.cpp (I already gave you upgraded version)

âŒ Error 3 â€” Google Test Not Linking
undefined reference to testing::InitGoogleTest

âœ… Fix

Build gtest once:

cd /usr/src/gtest
sudo cmake .
sudo make
sudo cp lib/*.a /usr/lib

âŒ Error 4 â€” Wrong Key Size

If key != 16 bytes:

EncryptInit failed

âœ… Fix

Ensure:

AppSKey = 16 bytes
NwkSKey = 16 bytes

âŒ Error 5 â€” MIC mismatch on server

Cause:

Wrong B0 block
Wrong direction bit
Wrong fCnt

âœ… Fix

Use spec-correct MIC block (already provided earlier)

âŒ Error 6 â€” Payload decrypt fails

Cause:

Wrong devAddr
Wrong fCnt
Wrong block counter

âœ… Fix

Ensure same values used in encryption + verification

âŒ Error 7 â€” CMake OpenSSL not found
Could NOT find OpenSSL

âœ… Fix
sudo apt install libssl-dev

âœ… How Frame Counter Prevents Attack

Without counter:

Attacker replays old packet â†’ accepted


With counter:

Old counter detected â†’ rejected

âœ… Security Meaning (Simple)
Feature	Protection
Encryption	Nobody reads data
MIC	Nobody modifies data
Frame Counter	Nobody replays packet
âœ… Now You Asked for README â€” Here It Is

You can directly paste this into README.md.

Writing
LoRaWAN Secure Payload Builder (C++ + OpenSSL + GoogleTest)
Overview

This project implements a simplified LoRaWAN-style secure message system in C++. It supports:

Payload encryption using AppSKey

Message integrity signing using NwkSKey (AES-CMAC)

Frame counter (fCntUp) management

LoRaWAN uplink payload construction

Unit testing using GoogleTest

OpenSSL 3 compatible crypto implementation

Buildable on Ubuntu / WSL using CMake

This project demonstrates how LoRaWAN devices securely build uplink packets.

Features

AES-128 payload encryption

AES-CMAC MIC generation

Frame counter increment logic

Spec-style MIC B0 block construction

Clean modular architecture

GoogleTest unit tests

OpenSSL EVP API (no deprecated calls)

Project Structure
lorawan_crypto/
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ Crypto.h
â”‚   â”œâ”€â”€ FrameCounter.h
â”‚   â””â”€â”€ LoRaPayload.h
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Crypto.cpp
â”‚   â”œâ”€â”€ FrameCounter.cpp
â”‚   â””â”€â”€ LoRaPayload.cpp
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_crypto.cpp
â”œâ”€â”€ CMakeLists.txt
Architecture
Application Data
    â†“
Crypto Engine (AES + CMAC)
    â†“
Frame Counter Manager
    â†“
LoRa Payload Builder
    â†“
Final Secure Packet

Modules:

Crypto â€” encryption + CMAC

FrameCounter â€” fCntUp tracking

LoRaPayload â€” builds LoRaWAN uplink packet

Build Instructions (Ubuntu / WSL)
Install dependencies
sudo apt update
sudo apt install build-essential cmake libssl-dev libgtest-dev

Build GoogleTest:

cd /usr/src/gtest
sudo cmake .
sudo make
sudo cp lib/*.a /usr/lib
Build project
mkdir build
cd build
cmake ..
make
Run tests
./tests

Expected output:

[ PASSED ] All tests
How Encryption Works

Payload is encrypted using:

EncryptedBlock = AES(AppSKey, CounterBlock)
Ciphertext = Payload XOR EncryptedBlock
How MIC Works

MIC is calculated using:

CMAC(NwkSKey, B0 | message)

Only first 4 bytes are used as MIC.

Frame Counter

Increments per uplink message

Prevents replay attacks

Included in MIC calculation

Common Errors & Fixes

OpenSSL headers missing:

sudo apt install libssl-dev

GoogleTest link errors:

Build gtest manually from /usr/src/gtest.

Wrong key size:

Keys must be 16 bytes.

Test Coverage

Frame counter increment test

Encryption output validation

Payload build validation

Educational Purpose

This project is designed for:
LoRaWAN learners
Embedded developers
Security engineers
C++ system programmers
Future Extensions
OTAA join procedure
Downlink decryption
MIC verification
Packet parser
Full LoRaWAN 1.0.4 compliance
Replay protection logic
Wireshark test vectors

